<script>
    const agents = ["professional", "moderate", "friendly"];
    let currentAgentIndex = 0;
    let allResponses = [];

    const interactionSection = document.getElementById("interaction-section");
    const followUpSection = document.getElementById("follow-up-section");
    const followUpForm = document.getElementById("follow-up-form");
    const submitFollowUpButton = document.getElementById("submit-follow-up");
    const continueInstructions = document.getElementById("continue-instructions");

    // Function to start interacting with an agent
    async function runAgent() {
        const agentType = agents[currentAgentIndex];
        const response = await fetch('/bot', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ agent_type: agentType })
        });
        const result = await response.json();

        // Display the conversation
        const conversationList = document.getElementById("conversation-list");
        conversationList.innerHTML = ""; // Clear previous results
        result.questions_and_responses.forEach((entry) => {
            const listItem = document.createElement('li');
            listItem.textContent = `Q: ${entry.question} - A: ${entry.response}`;
            conversationList.appendChild(listItem);
        });

        // Store the responses for this agent
        allResponses.push({ agent: agentType, sessionResponses: result.questions_and_responses });

        // Transition to follow-up section
        showFollowUpSection(agentType);
    }

    // Show follow-up questions after agent interaction
    function showFollowUpSection(agentType) {
        interactionSection.style.display = "none"; // Hide the interaction section
        followUpSection.style.display = "block"; // Show the follow-up section
        continueInstructions.style.display = "block"; // Show "Press space bar" instructions

        const followUpHeader = document.getElementById("follow-up-header");
        followUpHeader.textContent = `Follow-Up Questions for the ${agentType} Agent`;

        // Wait for the user to press the space bar
        document.addEventListener("keydown", handleSpaceBar);
    }

    // Handle space bar press
    function handleSpaceBar(event) {
        if (event.code === "Space") {
            document.removeEventListener("keydown", handleSpaceBar); // Remove the event listener
            continueInstructions.style.display = "none"; // Hide the instructions
            submitFollowUpButton.style.display = "block"; // Show the submit button
        }
    }

    // Handle follow-up form submission
    submitFollowUpButton.onclick = async () => {
        const formData = new FormData(followUpForm);
        const followUpResponses = {};
        formData.forEach((value, key) => {
            followUpResponses[key] = value;
        });

        // Store the follow-up responses for the current agent
        allResponses[currentAgentIndex].followUpResponses = followUpResponses;

        // Move to the next agent or finish
        currentAgentIndex++;
        if (currentAgentIndex < agents.length) {
            resetForNextAgent();
            await runAgent();
        } else {
            finishInteraction();
        }
    };

    // Reset the UI for the next agent
    function resetForNextAgent() {
        followUpForm.reset(); // Clear the form
        followUpSection.style.display = "none"; // Hide follow-up section
        interactionSection.style.display = "block"; // Show interaction section
        submitFollowUpButton.style.display = "none"; // Hide the submit button
    }

    // Finalize the interaction
    function finishInteraction() {
        followUpSection.style.display = "none"; // Hide the follow-up section
        const title = document.getElementById("title");
        title.textContent = "Thank you for your responses!";
        console.log("Final Responses:", allResponses); // Debugging: Log all responses
    }

    // Start the interaction process
    document.getElementById("start-interaction").onclick = runAgent;
</script>
